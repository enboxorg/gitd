name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ---------------------------------------------------------------------------
  # Detect whether source code changed. Docs-only PRs skip the pipeline but
  # the ci-passed gate job still reports success (required for branch protection).
  # ---------------------------------------------------------------------------
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.filter.outputs.src }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for source changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          predicate-quantifier: 'every'
          filters: |
            src:
              - '**'
              - '!**/*.md'
              - '!docs/**'
              - '!LICENSE'

  # ---------------------------------------------------------------------------
  # Lint, build, and test
  # ---------------------------------------------------------------------------
  build-and-test:
    name: Lint, Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.src == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore bun cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-store-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-store-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

      - name: Test with coverage
        run: bun test .spec.ts --coverage --coverage-reporter=lcov --coverage-dir=coverage

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # DHT integration tests (non-blocking)
  #
  # Runs the did:dht resolution tests against the live DHT gateway. These are
  # network-dependent and may flake, so they do not block the ci-passed gate.
  # ---------------------------------------------------------------------------
  dht-integration:
    name: DHT Integration
    runs-on: ubuntu-latest
    needs: [changes, build-and-test]
    if: needs.changes.outputs.src == 'true' && needs.build-and-test.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore bun cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-store-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-store-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Run DHT integration tests
        env:
          DID_DHT_GATEWAY_URI: https://enbox-did-dht.fly.dev
        run: bun test tests/git-remote.spec.ts --timeout 30000

  # ---------------------------------------------------------------------------
  # Gate job for branch protection. Always runs; succeeds when the pipeline
  # passes OR when it was skipped (docs-only change).
  # ---------------------------------------------------------------------------
  ci-passed:
    name: CI Passed
    runs-on: ubuntu-latest
    needs: [changes, build-and-test]
    if: always()
    steps:
      - name: Verify pipeline result
        run: |
          if [[ "${{ needs.changes.outputs.src }}" != "true" ]]; then
            echo "No source changes â€” skipping."
            exit 0
          fi
          if [[ "${{ needs.build-and-test.result }}" != "success" ]]; then
            echo "build-and-test failed."
            exit 1
          fi
          echo "All checks passed."
